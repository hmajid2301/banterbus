image: nixos/nix

workflow:
  auto_cancel:
    on_new_commit: interruptible

default:
  interruptible: true

variables:
  IMAGE_TAG: 0.1.0
  BANTERBUS_CI_IMAGE: $CI_REGISTRY_IMAGE/ci:$IMAGE_TAG

stages:
  - pre
  - deps
  - test
  - build
  - deploy
  - release

.task:
  stage: test
  image: $BANTERBUS_CI_IMAGE
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    paths:
      - ${GOPATH}/pkg/mod
    policy: pull
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  before_script:
    # INFO: Used to create directory, needed for tests and linter
    - mkdir /tmp

.test:
  coverage: /total:\s+\(statements\)\s+\d+.\d+%/
  variables:
     GOTESTSUM_JUNITFILE: "report.xml"
     XDG_DATA_HOME: "/tmp/"
     GOTEST_EXTRA_ARGS: "-coverprofile=coverage.txt"
  after_script:
    - task coverage
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

.docker:
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    IMMUTABLE: "true"
  services:
    - docker:27-dind
  before_script:
    - echo "experimental-features = nix-command flakes" > /etc/nix/nix.conf
    - nix-env -iA nixpkgs.docker nixpkgs.go-task
  script:
    - task docker:publish

publish:docker:ci:
  stage: pre
  variables:
    IMAGE: $BANTERBUS_CI_IMAGE
    FLAKE_TARGET: container-ci
    LOCAL_IMAGE: banterbus-dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "containers/ci.nix"
  services:
    - docker:27-dind
  extends:
    - .docker


download:dependency:
  extends: .task
  stage: deps
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      # INFO: until cache works with custom runner
      changes:
        - go.mod
        - go.sum
  script:
    - go mod download
  cache:
    policy: pull-push

lint:
  extends:
    - .task
  script:
    - task lint

format:
  extends:
    - .task
  script:
    - task format
    - git diff --exit-code

generate:
  extends:
    - .task
  script:
    - task generate
    - git diff --exit-code

tests:unit:
  extends:
    - .task
    - .test
  script:
    - task tests:unit -- ${GOTEST_EXTRA_ARGS}

tests:integration:
  extends:
    - .task
    - .test
  script:
    - task tests:integration -- ${GOTEST_EXTRA_ARGS}

# TODO: work out how to work with Nix
test:e2e:
  extends:
    - .task
  image: ghcr.io/manfromth3m0on/playwright-go:v0.4702.0
  before_script:
    - apt-get install wget tar -y
    - wget https://go.dev/dl/go1.22.5.linux-amd64.tar.gz
    - tar -xvf go1.22.5.linux-amd64.tar.gz -C /usr/local > /dev/null 2>&1
  script:
    - /usr/local/go/bin/go test ./tests/e2e/...
  artifacts:
    when: always
    paths:
      - tests/e2e/videos/*

#TODO: tag image using dev SHA
publish:dev:docker:
  stage: build
  needs: []
  variables:
    IMAGE: $CI_REGISTRY_IMAGE:dev
    FLAKE_TARGET: container
    LOCAL_IMAGE: banterbus
    IMMUTABLE: "false"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  extends:
    - .docker

deploy:dev:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - kubectl config use-context hmajid2301/k3s-config:ms01
    - kubectl rollout restart deployment banterbus -n dev

#TODO: promote image from dev to prod
#TODO: tag image using TAG
publish:prod:docker:
  stage: build
  rules:
    - if: $CI_COMMIT_TAG
  needs: []
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - docker:27-dind
  script:
    - echo "experimental-features = nix-command flakes" > /etc/nix/nix.conf
    - nix-env -iA nixpkgs.docker
    - nix develop -c task build:dev
    - nix build .#container
    - nix develop -c task docker:publish

release:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
  extends:
    - .task
  variables:
    GIT_DEPTH: 0
  script:
    - task release

